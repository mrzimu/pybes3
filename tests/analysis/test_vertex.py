import awkward as ak
import numpy as np

import pybes3.analysis as ana


def test_query_vertex():
    runs = [
        71235,
        71237,
        71238,
        71239,
        71240,
        71241,
        71242,
        71243,
        71244,
        71245,
        71246,
        71247,
        71248,
        71249,
        71250,
        71251,
        71252,
        71253,
        71254,
        71255,
        71256,
        71257,
        71258,
        71259,
        71260,
        71261,
        71263,
        71264,
        71265,
        71266,
        71267,
        71268,
        71269,
        71270,
        71271,
        71272,
        71273,
        71274,
        71275,
        71276,
        71277,
        71278,
        71279,
        71280,
        71281,
        71282,
        71283,
        71284,
        71285,
        71286,
        71287,
        71288,
        71289,
        71290,
        71291,
        71292,
        71293,
        71294,
        71295,
        71296,
        71297,
        71298,
        71299,
        71300,
        71301,
        71302,
        71303,
        71304,
        71305,
        71306,
        71307,
        71308,
        71309,
        71310,
        71311,
        71312,
        71313,
        71314,
        71315,
        71316,
        71317,
        71318,
        71319,
        71320,
        71321,
        71322,
        71323,
        71324,
        71325,
        71326,
        71327,
        71328,
        71329,
        71330,
        71331,
        71332,
        71333,
        71334,
        71335,
    ]

    header_runs = np.random.choice(runs, 1000000)
    db_conn = ana.DatabaseConnector(
        host="bes3db2.ihep.ac.cn", user="guest", passwd="guestpass"
    )
    res = ana.query_vertex(ak.Array(header_runs), "7.1.2", db_conn)
    assert len(res) == len(header_runs)
    assert set(res.fields) == {"x", "y", "z", "sigma_x", "sigma_y", "sigma_z"}
